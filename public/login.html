<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login - Personal AI Coach</title>
  <meta name="description" content="Login to access your AI coaching session">

  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0ea5e9">

  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    .login-wrapper {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      position: relative;
    }

    .login-card {
      background: white;
      border-radius: 24px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15),
        0 8px 24px rgba(0, 0, 0, 0.1);
      padding: 56px 48px;
      width: 100%;
      max-width: 560px;
      border: 1px solid rgba(226, 232, 240, 0.8);
      position: relative;
      overflow: hidden;
    }

    .login-card::before {
      display: none;
      /* Remove color line from top */
    }

    .login-header {
      text-align: center;
      margin-bottom: 32px;
    }

    .login-logo {
      width: 180px;
      height: 180px;
      margin: 0 auto 24px;
      position: relative;
    }

    .login-logo .profile-container {
      width: 180px;
      height: 180px;
      margin: 0 auto;
    }

    .login-logo .profile-img {
      width: 180px;
      height: 180px;
      border: 4px solid #0ea5e9;
      box-shadow: 0 6px 16px rgba(14, 165, 233, 0.3);
    }

    .login-header h1 {
      font-size: 2rem;
      font-weight: 700;
      color: #0f172a;
      margin: 0 0 8px 0;
      letter-spacing: -0.5px;
    }

    .login-header p {
      color: #64748b;
      font-size: 0.95rem;
      margin: 0;
    }

    .login-form {
      width: 100%;
    }

    .form-group {
      margin-bottom: 20px;
      position: relative;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      color: #334155;
      font-size: 0.875rem;
      margin-bottom: 8px;
    }

    .form-group input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-size: 0.95rem;
      transition: all 0.2s;
      background: #f8fafc;
      font-family: inherit;
    }

    .form-group input:focus {
      outline: none;
      border-color: #0ea5e9;
      background: white;
      box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.1);
    }

    .form-group input::placeholder {
      color: #94a3b8;
    }

    .forgot-password {
      text-align: right;
      margin-bottom: 24px;
    }

    .forgot-password a {
      color: #0ea5e9;
      text-decoration: none;
      font-size: 0.875rem;
      font-weight: 500;
      transition: color 0.2s;
    }

    .forgot-password a:hover {
      color: #0284c7;
      text-decoration: underline;
    }

    .btn-login {
      width: 100%;
      padding: 14px 24px;
      background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
      margin-bottom: 24px;
    }

    .btn-login:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(14, 165, 233, 0.4);
    }

    .btn-login:active {
      transform: translateY(0);
    }

    .divider {
      display: flex;
      align-items: center;
      text-align: center;
      margin: 24px 0;
      color: #94a3b8;
      font-size: 0.875rem;
    }

    .divider::before,
    .divider::after {
      content: '';
      flex: 1;
      border-bottom: 1px solid #e2e8f0;
    }

    .divider span {
      padding: 0 16px;
    }

    .google-signin-container {
      margin-bottom: 24px;
      display: flex;
      /* Enables flexbox layout */
      justify-content: center;
      /* Centers the button horizontally */
      width: 100%;
      /* Ensures the container fills the card width */
    }

    .signup-link {
      text-align: center;
      color: #64748b;
      font-size: 0.9rem;
      margin-top: 24px;
    }

    .signup-link a {
      color: #0ea5e9;
      text-decoration: none;
      font-weight: 600;
      transition: color 0.2s;
    }

    .signup-link a:hover {
      color: #0284c7;
      text-decoration: underline;
    }

    .error-message {
      display: none;
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      color: #991b1b;
      border: 2px solid #ef4444;
      border-radius: 12px;
      padding: 14px 18px;
      margin-bottom: 20px;
      font-size: 0.875rem;
      font-weight: 500;
      animation: slideDown 0.3s;
    }

    @keyframes slideDown {
      from {
        transform: translateY(-10px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .error-message::before {
      content: '⚠️ ';
      margin-right: 8px;
    }

    @media (max-width: 640px) {
      .login-card {
        padding: 32px 24px;
        border-radius: 20px;
      }

      .login-header h1 {
        font-size: 1.75rem;
      }

      .login-logo {
        width: 140px;
        height: 140px;
        margin-bottom: 20px;
      }

      .login-logo .profile-container {
        width: 140px;
        height: 140px;
      }

      .login-logo .profile-img {
        width: 140px;
        height: 140px;
        border: 3px solid #0ea5e9;
      }
    }
  </style>
</head>

<body>
  <div class="login-wrapper">
    <div class="login-card">
      <div class="login-header">
        <div class="login-logo">
          <div class="profile-container">
            <img src="coach.jpg" alt="Ronit" class="profile-img">
          </div>
        </div>
        <h1>Welcome Back</h1>
        <p>Login to continue your journey with Ronit AI</p>
      </div>

      <div id="loginError" class="error-message"></div>

      <div class="google-signin-container">
        <div id="google-signin-button"></div>
      </div>

      <div class="signup-link">
        Don't have an account? <a href="/signup.html" id="signupLink">Sign Up</a>
      </div>
    </div>
  </div>

  <footer id="mainFooter"
    style="position: fixed; bottom: 0; left: 0; right: 0; text-align: center; padding: 16px; background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); border-top: 1px solid #e2e8f0; z-index: 100;">
    <p style="margin: 0; color: #64748b; font-size: 0.875rem;">
      Copyright 2025 AI Coach | <a href="#" style="color: #0ea5e9; text-decoration: none;">Terms</a> | <a href="#"
        style="color: #0ea5e9; text-decoration: none;">Privacy</a>
    </p>
  </footer>

  <script type="module">
    let GOOGLE_CLIENT_ID = '';

    // Fetch Google Client ID from backend
    async function loadGoogleClientId() {
      try {
        const response = await fetch('/config');
        const config = await response.json();
        if (config.googleClientId && config.hasGoogleAuth) {
          GOOGLE_CLIENT_ID = config.googleClientId;
          console.log('Google Client ID loaded from backend');
        } else {
          console.warn('Google Client ID not configured. Please set GOOGLE_CLIENT_ID environment variable.');
          // Hide Google button if not configured
          const googleButton = document.getElementById('google-signin-button');
          const divider = document.getElementById('dividerOr');
          if (googleButton) {
            googleButton.style.display = 'none';
          }
          if (divider) {
            divider.style.display = 'none';
          }
        }
      } catch (error) {
        console.error('Error loading config:', error);
      }
    }

    // Function to handle successful login (both email and Google)
    async function handleSuccessfulLogin(userEmail, userName, userPicture = null, talktime = null) {
      // Store user data in sessionStorage
      sessionStorage.setItem('userEmail', userEmail);
      sessionStorage.setItem('userName', userName);
      if (userPicture) {
        sessionStorage.setItem('userPicture', userPicture);
      }
      sessionStorage.setItem('isLoggedIn', 'true');

      // Fetch user talktime if not provided
      if (talktime === null) {
        try {
          const response = await fetch(`/api/user/talktime?email=${encodeURIComponent(userEmail)}`);
          const data = await response.json();
          if (data.ok) {
            sessionStorage.setItem('userTalktime', data.talktime.toString());
          }
        } catch (error) {
          console.warn('Failed to fetch talktime:', error);
        }
      } else {
        sessionStorage.setItem('userTalktime', talktime.toString());
      }

      // Redirect to Ronit start call page
      window.location.href = '/';
    }

    // Initialize Google Sign-In
    function initializeGoogleSignIn() {
      if (typeof google === 'undefined' || !google.accounts) {
        console.warn('Google Identity Services not loaded. Please check your internet connection.');
        return;
      }

      // Only initialize if we have a valid client ID
      if (GOOGLE_CLIENT_ID && GOOGLE_CLIENT_ID.length > 0) {
        google.accounts.id.initialize({
          client_id: GOOGLE_CLIENT_ID,
          callback: handleGoogleSignIn,
          auto_select: false,
          cancel_on_tap_outside: true
        });

        // Render the button with "Login" text
        const buttonContainer = document.getElementById('google-signin-button');
        if (buttonContainer) {
          google.accounts.id.renderButton(buttonContainer, {
            type: 'standard',
            theme: 'outline',
            size: 'large',
            text: 'signin_with',  // Shows "Sign in with Google"
            width: '100%',
            locale: 'en'
          });
        }
      } else {
        // Hide Google button if client ID is not configured
        const googleButton = document.getElementById('google-signin-button');
        const divider = document.getElementById('dividerOr');
        if (googleButton) {
          googleButton.style.display = 'none';
        }
        if (divider) {
          divider.style.display = 'none';
        }
      }
    }

    // Handle Google Sign-In callback
    async function handleGoogleSignIn(response) {
      try {
        // Send raw credential to backend for server-side verification
        console.log('Sending Google credential to backend for verification...');

        const res = await fetch('/api/auth/google', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            credential: response.credential  // Send raw credential, not decoded
          })
        });

        const data = await res.json();

        // Handle Success/Fail
        if (data.ok && data.token) {
          // Store app-generated JWT token
          sessionStorage.setItem('authToken', data.token);

          // Save user data to Session Storage
          sessionStorage.setItem('userEmail', data.email);
          sessionStorage.setItem('userName', data.name || data.email.split('@')[0]);
          sessionStorage.setItem('userTalktime', data.talktime.toString());
          sessionStorage.setItem('isLoggedIn', 'true');

          // Redirect
          window.location.href = '/';
        } else {
          const errorDiv = document.getElementById('loginError');
          errorDiv.textContent = data.message || 'Google login failed. Please try again.';
          errorDiv.style.display = 'block';
          setTimeout(() => {
            errorDiv.style.display = 'none';
          }, 5000);
        }
      } catch (error) {
        console.error('Error processing Google Sign-In:', error);
        const errorDiv = document.getElementById('loginError');
        errorDiv.textContent = 'System error during login. Please try again.';
        errorDiv.style.display = 'block';
        setTimeout(() => {
          errorDiv.style.display = 'none';
        }, 5000);
      }
    }

    // Wait for Google Identity Services to load
    window.addEventListener('load', async () => {
      // First load the Google Client ID from backend
      await loadGoogleClientId();

      // Then initialize Google Sign-In
      if (typeof google !== 'undefined' && google.accounts) {
        initializeGoogleSignIn();
      } else {
        // Wait a bit more for the script to load
        setTimeout(initializeGoogleSignIn, 500);
      }
    });

    // Check for signup success message
    window.addEventListener('load', () => {
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('signup') === 'success') {
        const errorDiv = document.getElementById('loginError');
        errorDiv.style.background = 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)';
        errorDiv.style.color = '#065f46';
        errorDiv.style.borderColor = '#10b981';
        errorDiv.textContent = '✅ Account created successfully! Please login with your credentials.';
        errorDiv.style.display = 'block';
        setTimeout(() => {
          errorDiv.style.display = 'none';
        }, 5000);
      }
    });

    // Manual login form removed - Google Sign-In only

    // Sign up handler
    document.getElementById('signupLink').addEventListener('click', (e) => {
      e.preventDefault();
      window.location.href = '/signup.html';
    });
  </script>
</body>

</html>