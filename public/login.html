<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login - Personal AI Coach</title>
  <meta name="description" content="Login to access your AI coaching session">
  <link rel="icon" type="image/svg+xml" sizes="any" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect fill='%23065F46' width='64' height='64' rx='12'/%3E%3Cpath fill='white' d='M32 52c-2.5-2.2-10-7-13-10-3-3-4.5-6-4.5-8.5 0-4 2.5-7 6.5-7 2.5 0 4.5 1 5.8 2.5 1.3-1.5 3.3-2.5 5.8-2.5 4 0 6.5 3 6.5 7 0 2.5-1.5 5.5-4.5 8.5-3 3-10.5 7.8-13 10z'/%3E%3C/svg%3E">
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0ea5e9">

  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    .login-wrapper {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      position: relative;
    }

    .login-card {
      background: white;
      border-radius: 24px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15),
        0 8px 24px rgba(0, 0, 0, 0.1);
      padding: 56px 48px;
      width: 100%;
      max-width: 560px;
      border: 1px solid rgba(226, 232, 240, 0.8);
      position: relative;
      overflow: hidden;
    }

    .login-card::before {
      display: none;
      /* Remove color line from top */
    }

    .login-header {
      text-align: center;
      margin-bottom: 32px;
    }

    .login-logo {
      width: 180px;
      height: 180px;
      margin: 0 auto 24px;
      position: relative;
    }

    .login-logo .profile-container {
      width: 180px;
      height: 180px;
      margin: 0 auto;
    }

    .login-logo .profile-img {
      width: 180px;
      height: 180px;
      border: 4px solid #0ea5e9;
      box-shadow: 0 6px 16px rgba(14, 165, 233, 0.3);
    }

    .login-header h1 {
      font-size: 2rem;
      font-weight: 700;
      color: #0f172a;
      margin: 0 0 8px 0;
      letter-spacing: -0.5px;
    }

    .login-header p {
      color: #64748b;
      font-size: 0.95rem;
      margin: 0;
    }

    .login-form {
      width: 100%;
    }

    .form-group {
      margin-bottom: 20px;
      position: relative;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      color: #334155;
      font-size: 0.875rem;
      margin-bottom: 8px;
    }

    .form-group input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-size: 0.95rem;
      transition: all 0.2s;
      background: #f8fafc;
      font-family: inherit;
    }

    .form-group input:focus {
      outline: none;
      border-color: #0ea5e9;
      background: white;
      box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.1);
    }

    .form-group input::placeholder {
      color: #94a3b8;
    }

    .forgot-password {
      text-align: right;
      margin-bottom: 24px;
    }

    .forgot-password a {
      color: #0ea5e9;
      text-decoration: none;
      font-size: 0.875rem;
      font-weight: 500;
      transition: color 0.2s;
    }

    .forgot-password a:hover {
      color: #0284c7;
      text-decoration: underline;
    }

    .btn-login {
      width: 100%;
      padding: 14px 24px;
      background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
      margin-bottom: 24px;
    }

    .btn-login:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(14, 165, 233, 0.4);
    }

    .btn-login:active {
      transform: translateY(0);
    }

    .divider {
      display: flex;
      align-items: center;
      text-align: center;
      margin: 24px 0;
      color: #94a3b8;
      font-size: 0.875rem;
    }

    .divider::before,
    .divider::after {
      content: '';
      flex: 1;
      border-bottom: 1px solid #e2e8f0;
    }

    .divider span {
      padding: 0 16px;
    }

    .google-signin-container {
      margin-bottom: 24px;
      display: flex;
      /* Enables flexbox layout */
      justify-content: center;
      /* Centers the button horizontally */
      width: 100%;
      /* Ensures the container fills the card width */
    }

    .signup-link {
      text-align: center;
      color: #64748b;
      font-size: 0.9rem;
      margin-top: 24px;
    }

    .signup-link a {
      color: #0ea5e9;
      text-decoration: none;
      font-weight: 600;
      transition: color 0.2s;
    }

    .signup-link a:hover {
      color: #0284c7;
      text-decoration: underline;
    }

    .error-message {
      display: none;
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      color: #991b1b;
      border: 2px solid #ef4444;
      border-radius: 12px;
      padding: 14px 18px;
      margin-bottom: 20px;
      font-size: 0.875rem;
      font-weight: 500;
      animation: slideDown 0.3s;
    }

    @keyframes slideDown {
      from {
        transform: translateY(-10px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.02);
      }
    }

    .error-message::before {
      content: '⚠️ ';
      margin-right: 8px;
    }

    @media (max-width: 640px) {
      .login-card {
        padding: 32px 24px;
        border-radius: 20px;
      }

      .login-header h1 {
        font-size: 1.75rem;
      }

      .login-logo {
        width: 140px;
        height: 140px;
        margin-bottom: 20px;
      }

      .login-logo .profile-container {
        width: 140px;
        height: 140px;
      }

      .login-logo .profile-img {
        width: 140px;
        height: 140px;
        border: 3px solid #0ea5e9;
      }
    }
  </style>
</head>

<body>
  <div class="login-wrapper">
    <div class="login-card">
      <div class="login-header">
        <div class="login-logo">
          <div class="profile-container">
            <img src="coach.jpg" alt="Ronit" class="profile-img">
          </div>
        </div>
        <h1>Welcome Back</h1>
        <p>Login to continue your journey with Ronit AI</p>
      </div>

      <div id="loginError" class="error-message"></div>

      <!-- Google Sign-In Button -->
      <div class="google-signin-container" id="googleSignInContainer" style="display: none;">
        <div id="google-signin-button"></div>
      </div>

      <!-- Manual Login Form -->
      <form id="manualLoginForm" class="login-form">
        <div class="form-group">
          <label for="email">Email Address</label>
          <input type="email" id="email" name="email" required placeholder="name@example.com" autocomplete="email">
        </div>
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" name="password" required placeholder="Enter your password"
            autocomplete="current-password">
        </div>

        <button type="submit" class="btn-login">
          Login
        </button>
      </form>

      <!-- Divider (only show if Google Sign-In is available) -->
      <div class="divider" id="loginDivider" style="display: none;">
        <span>OR</span>
      </div>

      <div class="signup-link">
        Don't have an account? <a href="/signup.html" id="signupLink">Sign Up</a>
      </div>
    </div>
  </div>

  <footer id="mainFooter"
    style="position: fixed; bottom: 0; left: 0; right: 0; text-align: center; padding: 16px; background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); border-top: 1px solid #e2e8f0; z-index: 100;">
    <p style="margin: 0; color: #64748b; font-size: 0.875rem;">
      Copyright 2025 AI Coach | <a href="#" style="color: #0ea5e9; text-decoration: none;">Terms</a> | <a href="#"
        style="color: #0ea5e9; text-decoration: none;">Privacy</a>
    </p>
  </footer>

  <script>
    let GOOGLE_CLIENT_ID = '';
    
    // Load Google Client ID and initialize
    async function loadGoogleClientId() {
      try {
        const response = await fetch('/config');
        const config = await response.json();
        if (config.googleClientId) {
          GOOGLE_CLIENT_ID = config.googleClientId;
          initializeGoogleSignIn();
        }
      } catch (error) {
        console.error('Config Error:', error);
      }
    }
    
    // Initialize Google Sign-In Button
    function initializeGoogleSignIn() {
      if (typeof google === 'undefined' || !GOOGLE_CLIENT_ID) return;
      
      google.accounts.id.initialize({
        client_id: GOOGLE_CLIENT_ID,
        callback: handleGoogleLogin
      });
      
      google.accounts.id.renderButton(
        document.getElementById('google-signin-button'),
        { theme: 'outline', size: 'large', text: 'signin_with', width: '280' }
      );
      
      // Show Google Sign-In button and divider
      document.getElementById('googleSignInContainer').style.display = 'flex';
      document.getElementById('loginDivider').style.display = 'flex';
    }
    
    // Handle Google Sign-In
    async function handleGoogleLogin(response) {
      const errorDiv = document.getElementById('loginError');
      
      try {
        const res = await fetch('/api/auth/google', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            credential: response.credential
          })
        });
        
        const data = await res.json();
        
        if (data.ok && data.token) {
          try {
            sessionStorage.setItem('authToken', data.token);
            sessionStorage.setItem('userEmail', data.email);
            sessionStorage.setItem('userName', data.name || data.email.split('@')[0]);
            sessionStorage.setItem('userTalktime', (data.talktime || 0).toString());
            sessionStorage.setItem('isLoggedIn', 'true');
          } catch (e) {
            console.warn('Storage blocked:', e.message);
            alert('Your browser is blocking storage. Please allow cookies/storage for this site to stay logged in.');
          }
          window.location.href = '/';
        } else {
          errorDiv.textContent = data.message || 'Google Sign-In failed. Please try again.';
          errorDiv.style.display = 'block';
        }
      } catch (error) {
        console.error('Google Login Error:', error);
        errorDiv.textContent = 'Connection error during Google Sign-In. Please try again.';
        errorDiv.style.display = 'block';
      }
    }

    // Manual Login Handler
    document.getElementById('manualLoginForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();
      const errorDiv = document.getElementById('loginError');
      const submitBtn = e.target.querySelector('button[type="submit"]');

      // Basic validation
      if (!email || !password) {
        errorDiv.textContent = 'Please enter both email and password';
        errorDiv.style.display = 'block';
        return;
      }

      try {
        // Disable button during request
        submitBtn.disabled = true;
        submitBtn.textContent = 'Logging in...';

        const res = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        const data = await res.json();

        if (data.ok && data.token) {
          try {
            sessionStorage.setItem('authToken', data.token);
            sessionStorage.setItem('userEmail', data.email);
            sessionStorage.setItem('userName', data.name || data.email.split('@')[0]);
            sessionStorage.setItem('userTalktime', (data.talktime || 0).toString());
            sessionStorage.setItem('isLoggedIn', 'true');
          } catch (e) {
            console.warn('Storage blocked:', e.message);
            alert('Your browser is blocking storage. Please allow cookies/storage for this site to stay logged in.');
          }
          window.location.href = '/';
        } else {
          // Check if error suggests using Google Sign-In
          if (data.message && data.message.includes('Google Sign-In')) {
            errorDiv.textContent = data.message;
            errorDiv.style.display = 'block';
            // Optionally highlight Google Sign-In button
            if (document.getElementById('googleSignInContainer').style.display !== 'none') {
              document.getElementById('googleSignInContainer').style.animation = 'pulse 2s ease-in-out';
            }
          } else {
            errorDiv.textContent = data.message || 'Login failed. Please check your credentials.';
            errorDiv.style.display = 'block';
          }
        }
      } catch (error) {
        console.error('Login Error:', error);
        errorDiv.textContent = 'Connection error. Please try again.';
        errorDiv.style.display = 'block';
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Login';
      }
    });

    // Check for signup success message
    window.addEventListener('load', () => {
      loadGoogleClientId();
      
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('signup') === 'success') {
        const errorDiv = document.getElementById('loginError');
        errorDiv.style.background = 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)';
        errorDiv.style.color = '#065f46';
        errorDiv.style.borderColor = '#10b981';
        errorDiv.textContent = '✅ Account created successfully! Please login with your credentials.';
        errorDiv.style.display = 'block';
        setTimeout(() => {
          errorDiv.style.display = 'none';
        }, 5000);
      }
    });
  </script>
</body>

</html>